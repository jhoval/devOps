- hosts: all
  become: true
  tasks:
     - name: Check instance ping
       ping:

     - name: Install PHP
       apt:
         name: "{{ item }}"
         update_cache: yes
         cache_valid_time: 86400
         state: present
       with_items:
         - php5
         - php5-fpm
         - php5-mysql
         - php5-cli

     - name: Install MySQL Server & python-mysqldb
       apt:
         name: "{{ item }}"
         update_cache: yes
         cache_valid_time: 86400
         state: latest
       with_items:
         - mysql-server
         - python-mysqldb

     - name: Generate new root password
       command: openssl rand -hex 7 creates=/root/.my.cnf
       register: mysql_root_password

     - name: Remove anonymous users
       mysql_user:
         name: ""
         state: absent
       when: mysql_root_password.changed

     - name: Remove test database
       mysql_db:
         name: test
         state: absent
       when: mysql_root_password.changed

     - name: Output new root password
       debug: msg="New root password is {{mysql_root_password.stdout}}"
       when: mysql_root_password.changed

     - name: Update root password
       mysql_user:
         name: root
         host: "{{ item }}"
         password: "{{ mysql_root_password.stdout }}"
       with_items:
         - "{{ ansible_hostname }}"
         - 127.0.0.1
         - ::1
         - localhost
       when: mysql_root_password.changed

     - name: Create my.cnf
       template: src=templates/mysql/my.cnf dest=/root/.my.cnf
       when: mysql_root_password.changed
